__d(function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=(function(t){if(t&&t.__esModule)return t;if(null===t||"object"!=typeof t&&"function"!=typeof t)return{default:t};var n=_();if(n&&n.has(t))return n.get(t);var s={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var c in t)if(Object.prototype.hasOwnProperty.call(t,c)){var u=o?Object.getOwnPropertyDescriptor(t,c):null;u&&(u.get||u.set)?Object.defineProperty(s,c,u):s[c]=t[c]}s.default=t,n&&n.set(t,s);return s})(r(d[0])),n=r(d[1]),s=r(d[2]),o=b(r(d[3])),c=b(r(d[4])),u=r(d[5]),l=b(r(d[6])),f=r(d[7]),h=b(r(d[8])),p=r(d[9]),v=b(r(d[10])),y=r(d[11]),R=r(d[12]),k=b(r(d[13])),D=b(r(d[14]));function b(t){return t&&t.__esModule?t:{default:t}}function _(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return _=function(){return t},t}function F(t){return S(t)||O(t)||w()}function w(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function O(t){if(("function"==typeof Symbol?Symbol.iterator:"@@iterator")in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function S(t){if(Array.isArray(t)){for(var n=0,s=new Array(t.length);n<t.length;n++)s[n]=t[n];return s}}function x(t,n){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),s.push.apply(s,o)}return s}function I(t){for(var n=1;n<arguments.length;n++){var s=null!=arguments[n]?arguments[n]:{};n%2?x(Object(s),!0).forEach(function(n){E(t,n,s[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(s,n))})}return t}function E(t,n,s){return n in t?Object.defineProperty(t,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[n]=s,t}function P(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function j(t,n){for(var s=0;s<n.length;s++){var o=n[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function C(t){return(C=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function T(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function L(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&A(t,n)}function A(t,n){return(A=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function B(t,n){var s=(0,c.default)(t.validTo);if(!n.success)return s;var o=n.value.rules.maxDaysInFutureAvailableForReservation,u=(0,c.default)().add(o,'days').endOf('day');return c.default.min(s,u)}var M=(function(b){function _(t){var n,s,o;return P(this,_),s=this,o=C(_).call(this,t),(n=!o||"object"!=typeof o&&"function"!=typeof o?T(s):o).handleBackPress=function(){return n.props.navigation.state.params.onClose(),!0},n.state={seatReservationInformationFetch:{loading:!0},itineraries:{to:{itineraries:[],resultSetId:'',scrollForth:'',scrollBack:''},from:{itineraries:[],resultSetId:'',scrollForth:'',scrollBack:''}},isFetching:!0,isFetchingLater:!1,failedFetchingLater:!1,isRefreshing:!1,ticket:void 0,direction:'to',isSeatReserved:!1,activeItinerary:null,isFetchingReservationData:!0,reservationData:void 0,activeDate:(0,c.default)()},n.handleBackPress=n.handleBackPress.bind(T(n)),n}var w,O,S;return L(_,t.Component),w=_,(O=[{key:"componentDidMount",value:function(){return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:return this.fetchReservationInformation(),t.next=3,regeneratorRuntime.awrap(this.fetchReservationData());case 3:this.fetchItineraries();case 4:case"end":return t.stop()}},null,this)}},{key:"fetchReservationInformation",value:function(){var t;return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,regeneratorRuntime.awrap((0,u.getReservationInfo)());case 3:t=n.sent,this.setState({seatReservationInformationFetch:{success:!0,value:t}}),n.next=10;break;case 7:n.prev=7,n.t0=n.catch(0),this.setState({seatReservationInformationFetch:{error:!0,message:n.t0}});case 10:case"end":return n.stop()}},null,this,[[0,7]])}},{key:"fetchReservationData",value:function(){var t,n;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:return this.setState({isFetchingReservationData:!0}),s.prev=1,t=this.props.navigation.state.params.ticket.ticketId,s.next=5,regeneratorRuntime.awrap((0,u.getReservationDataForTicket)(t));case 5:n=s.sent,this.setReservationData(n),s.next=12;break;case 9:s.prev=9,s.t0=s.catch(1),this.setState({isFetchingReservationData:!1});case 12:case"end":return s.stop()}},null,this,[[1,9]])}},{key:"fetchItineraries",value:function(){var t,n,s,o,u,l,f,h,p,v,y=this;return regeneratorRuntime.async(function(R){for(;;)switch(R.prev=R.next){case 0:return s=this.props.navigation.state.params.ticket,o=s.stationFromCode,u=s.stationToCode,this.setState({isFetching:!0,itineraries:{to:{itineraries:[],resultSetId:'',scrollForth:'',scrollBack:''},from:{itineraries:[],resultSetId:'',scrollForth:'',scrollBack:''}}}),l=(null!=(t=null==(n=this.state.reservationData)?void 0:n.journeyReservations)?t:[]).filter(function(t){return(0,c.default)(t.departureTime).isSame(y.state.activeDate,'day')}),f=l.filter(function(t){return t.departureStationName===s.stationTo}),h=l.filter(function(t){return t.departureStationName===s.stationFrom}),p=this.state.activeDate,v=this.state.activeDate,f.length>0&&(p=(0,c.default)(f[0].departureTime).subtract(2,'minutes')),h.length>0&&(v=(0,c.default)(h[0].departureTime).subtract(2,'minutes')),this.fetchItinerariesForDirection({from:u,to:o,direction:'from',scrollContext:'',date:p}),R.next=13,regeneratorRuntime.awrap(this.fetchItinerariesForDirection({from:o,to:u,direction:'to',scrollContext:'',date:v}));case 13:this.setState({isFetching:!1});case 14:case"end":return R.stop()}},null,this)}},{key:"fetchItinerariesForDirection",value:function(t){var n,s,o,l,h,p,v,y;return regeneratorRuntime.async(function(R){for(;;)switch(R.prev=R.next){case 0:return n=t.from,s=t.to,o=t.direction,l=t.scrollContext,h=t.date,p=void 0===h?(0,c.default)().subtract(15,'minutes'):h,v=this.props.navigation.state.params.ticket,R.prev=2,R.next=5,regeneratorRuntime.awrap((0,u.getItineraryWithReservations)(v.ticketId,n,s,p.format(f.SERVER_DATE_FORMAT),l.length?l:void 0));case 5:y=R.sent,this.setState({ticket:v,itineraries:I({},this.state.itineraries,E({},o,{itineraries:y.itineraries,scrollBack:y.scrollBack,scrollForth:y.scrollForth}))}),R.next=12;break;case 9:R.prev=9,R.t0=R.catch(2),'FAILED_OLD_APP_VERSION'===R.t0.status?this.showAppIsDeprecatedError(R.t0.message,o):this.showItineraryRetrievalError(R.t0.message,o);case 12:case"end":return R.stop()}},null,this,[[2,9]])}},{key:"fetchLaterItinerariesForCurrentDirection",value:function(){var t,n,s,o,c,l,h;return regeneratorRuntime.async(function(p){for(;;)switch(p.prev=p.next){case 0:if(!this.state.isFetchingLater){p.next=2;break}return p.abrupt("return");case 2:return this.setState({isFetchingLater:!0}),t=this.state,n=t.direction,s=t.itineraries,o=this.props.navigation.state.params.ticket,c=o.stationFromCode,l=o.stationToCode,p.prev=6,p.next=9,regeneratorRuntime.awrap((0,u.getItineraryWithReservations)(o.ticketId,'to'===n?c:l,'to'===n?l:c,this.state.activeDate.format(f.SERVER_DATE_FORMAT),s[n].scrollForth));case 9:h=p.sent,this.setState({ticket:o,isFetchingLater:!1,itineraries:I({},this.state.itineraries,E({},n,{itineraries:[].concat(F(s[n].itineraries),F(h.itineraries)),scrollBack:h.scrollBack,scrollForth:h.scrollForth}))}),p.next=16;break;case 13:p.prev=13,p.t0=p.catch(6),this.setState({failedFetchingLater:!0,isFetchingLater:!1});case 16:case"end":return p.stop()}},null,this,[[6,13]])}},{key:"setReservationData",value:function(t){this.setState({isFetchingReservationData:!1,reservationData:{journeyReservations:t.journeyReservations.sort(R.sortByDepartureTime)}})}},{key:"handleOnRefresh",value:function(){this.fetchItineraries()}},{key:"handleEndReached",value:function(){var t=this.state,n=t.failedFetchingLater;!!t.itineraries[t.direction].scrollForth&&!n&&this.fetchLaterItinerariesForCurrentDirection()}},{key:"handleSwitchDirection",value:function(){var t=this,n=this.state,s=n.itineraries,o=n.activeDate,c=this.props.navigation.state.params.ticket,u=c.stationFromCode,l=c.stationToCode,f='to'===this.state.direction?'from':'to';this.setState({direction:f},function(){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:if(0!==s[f].itineraries.length){n.next=3;break}return n.next=3,regeneratorRuntime.awrap(t.fetchItinerariesForDirection({from:'to'===f?u:l,to:'to'===f?l:u,direction:f,scrollContext:'',date:o}));case 3:case"end":return n.stop()}})})}},{key:"showAppIsDeprecatedError",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,v.default)('app_is_deprecated_default_message');(arguments.length>1?arguments[1]:void 0)===this.state.direction&&n.Alert.alert((0,v.default)('app_is_deprecated_title'),t,[{text:'Ok',onPress:this.props.navigation.state.params.onClose}])}},{key:"showItineraryRetrievalError",value:function(t,s){s===this.state.direction&&n.Alert.alert((0,v.default)('itinerary_retrieval_alert_title'),t||(0,v.default)('itinerary_retrieval_alert_message'),[{text:'Ok',onPress:this.props.navigation.state.params.onClose}])}},{key:"navigateToSeatMap",value:function(t,n){var s=this;t&&n&&this.props.navigation.navigate('SeatChooserScreen',{itinerary:n,ticket:this.props.navigation.state.params.ticket,leg:t,onSeatReserved:function(){return s.reloadScreen()},onClose:this.props.navigation.state.params.onClose,direction:this.state.direction}),o.default.USER_CHOSE_SEAT_ON_LEG({from:t.from,to:t.to})}},{key:"reloadScreen",value:function(){var t;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:return t=this.props.navigation.state.params.updateReservationData,s.prev=1,s.next=4,regeneratorRuntime.awrap(this.fetchReservationData());case 4:return s.next=6,regeneratorRuntime.awrap(this.fetchItineraries());case 6:t(this.state.reservationData),s.next=12;break;case 9:s.prev=9,s.t0=s.catch(1),n.Alert.alert((0,v.default)('could_not_reload_screen_title'),(0,p.getMessageFromErrorIfPresent)(s.t0)||(0,v.default)('could_not_reload_screen_text'),[{text:'Ok'}]);case 12:case"end":return s.stop()}},null,this,[[1,9]])}},{key:"onCancelReservation",value:function(t,s){var o=this,c=this.props.navigation.state.params.onCancelReservation;n.Alert.alert((0,v.default)('cancel_seat_reservation_alert_title'),(0,v.default)('cancel_seat_reservation_alert_message'),[{text:(0,v.default)('alert_negative_button')},{text:(0,v.default)('alert_positive_button'),style:'cancel',onPress:function(){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap(c(t,s));case 2:o.reloadScreen();case 3:case"end":return n.stop()}})}}],{cancelable:!1})}},{key:"handleSwitchDepartureDate",value:function(t){var n=this,s=t.isSame((0,c.default)(),'day');this.setState({activeDate:s?(0,c.default)():t.clone().startOf('day')},function(){return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(n.fetchReservationData());case 2:n.fetchItineraries();case 3:case"end":return t.stop()}})})}},{key:"render",value:function(){var o=this,c=this.state,u=c.isFetching,f=c.isFetchingLater,p=c.isFetchingReservationData,v=c.failedFetchingLater,R=c.isRefreshing,b=c.itineraries,_=c.direction,F=c.activeDate,w=c.seatReservationInformationFetch,O=b[_].itineraries,S=this.props.navigation.state.params,x=S.ticket,I=S.onClose,E=B(x,w),P=(0,y.decorateDays)(this.state.activeDate,E);return t.default.createElement(D.default,{style:k.default.seatChooserContainer()},t.default.createElement(s.NavigationEvents,{onWillFocus:function(){return n.BackHandler.addEventListener('hardwareBackPress',o.handleBackPress)},onWillBlur:function(){return n.BackHandler.removeEventListener('hardwareBackPress',o.handleBackPress)}}),t.default.createElement(h.default,{ticket:x,onClose:I,direction:_,switchDirection:function(){return o.handleSwitchDirection()},canReserveTo:E,switchDepartureDate:function(t){return o.handleSwitchDepartureDate(t)},bookableDays:P,activeDate:this.state.activeDate}),t.default.createElement(l.default,{itineraries:O,onEndReached:function(){return o.handleEndReached()},onRefresh:function(){return o.handleOnRefresh()},isRefreshing:R,isFetching:u||p,isFetchingLater:f,hasFailedFetchingLater:v,hasLaterItineraries:!!b[_].scrollForth,footerTapped:function(){o.fetchLaterItinerariesForCurrentDirection()},onCancelReservation:function(t,n){return o.onCancelReservation(t,n)},isLastDayOfReservations:E.isSame(F,'day'),ticket:x,navigateToSeatMap:function(t,n){return o.navigateToSeatMap(t,n)},activeDate:F,changeDate:function(t){return o.handleSwitchDepartureDate(t)}}))}}])&&j(w.prototype,O),S&&j(w,S),_})();e.default=M},1754,[7,10,435,1294,630,1480,1755,414,1761,636,673,670,1622,1681,1289]);