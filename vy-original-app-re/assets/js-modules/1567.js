__d(function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=(function(t){if(t&&t.__esModule)return t;if(null===t||"object"!=typeof t&&"function"!=typeof t)return{default:t};var n=V();if(n&&n.has(t))return n.get(t);var s={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var c in t)if(Object.prototype.hasOwnProperty.call(t,c)){var l=o?Object.getOwnPropertyDescriptor(t,c):null;l&&(l.get||l.set)?Object.defineProperty(s,c,l):s[c]=t[c]}s.default=t,n&&n.set(t,s);return s})(r(d[0])),n=D(r(d[1])),s=D(r(d[2])),o=r(d[3]),c=r(d[4]),l=r(d[5]),u=D(r(d[6])),f=r(d[7]),h=r(d[8]),p=D(r(d[9])),v=D(r(d[10])),y=D(r(d[11])),k=r(d[12]),S=r(d[13]),b=r(d[14]),B=r(d[15]);function D(t){return t&&t.__esModule?t:{default:t}}function V(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return V=function(){return t},t}function w(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function I(t,n){if(("function"==typeof Symbol?Symbol.iterator:"@@iterator")in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var s=[],o=!0,c=!1,l=void 0;try{for(var u,f=t["function"==typeof Symbol?Symbol.iterator:"@@iterator"]();!(o=(u=f.next()).done)&&(s.push(u.value),!n||s.length!==n);o=!0);}catch(t){c=!0,l=t}finally{try{o||null==f.return||f.return()}finally{if(c)throw l}}return s}}function T(t){if(Array.isArray(t))return t}function O(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function E(t,n){for(var s=0;s<n.length;s++){var o=n[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function A(t){return(A=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function R(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function x(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&F(t,n)}function F(t,n){return(F=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}var j=(function(l){function D(t){var n,s,o;return O(this,D),s=this,(n=!(o=A(D).call(this,t))||"object"!=typeof o&&"function"!=typeof o?R(s):o).state={isFetching:!0,isFetchingVerification:!0,validationData:null,validationDataRetrievalError:!1,verificationError:null,screenBrightnessBeforeShowingInspection:null,fetchedValidationDataAt:null,isTicketScannedByStaff:!1},n.resetScreenBrightness=n.resetScreenBrightness.bind(R(n)),n.handleAppBecameActive=n.handleAppBecameActive.bind(R(n)),n.handleTicketScannedByStaff=n.handleTicketScannedByStaff.bind(R(n)),n}var V,F,j;return x(D,t.Component),V=D,(F=[{key:"componentDidMount",value:function(){var t=this.props,n=t.ticket,s=t.isVisible;n&&this.getValidationData(),s&&(k.logInspectionModalEvent.becameVisible(this.props.ticket.ticketId),this.increaseScreenBrightness())}},{key:"componentDidUpdate",value:function(t,n){var s=!t.isVisible&&this.props.isVisible;if(t.isVisible&&!this.props.isVisible)this.resetScreenBrightness();else if(s){k.logInspectionModalEvent.becameVisible(this.props.ticket.ticketId),this.increaseScreenBrightness(),(!n.fetchedValidationDataAt||M(n.fetchedValidationDataAt,this.props.ticket))&&this.getValidationData()}}},{key:"handleAppBecameActive",value:function(){if(this.props.isVisible){this.increaseScreenBrightness();var t=this.state.fetchedValidationDataAt;t||B.remoteLogger.error(B.sources.BUGS,'this.state.fetchedValidationDataAt is undefined',{state:JSON.stringify(this.state)}),t&&!M(t,this.props.ticket)||this.getValidationData()}}},{key:"increaseScreenBrightness",value:function(){var t;return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,this.state.screenBrightnessBeforeShowingInspection){n.next=6;break}return n.next=4,regeneratorRuntime.awrap((0,S.getScreenBrightness)());case 4:t=n.sent,this.setState({screenBrightnessBeforeShowingInspection:t},function(){return(0,S.setScreenBrightness)(1)});case 6:n.next=11;break;case 8:n.prev=8,n.t0=n.catch(0),console.log('Unable to get current brightness from native',n.t0);case 11:case"end":return n.stop()}},null,this,[[0,8]])}},{key:"resetScreenBrightness",value:function(){var t=this.state.screenBrightnessBeforeShowingInspection;null!==t&&((0,S.setScreenBrightness)(t),this.setState({screenBrightnessBeforeShowingInspection:null}))}},{key:"getValidationData",value:function(){var t=this;this.setState({isFetching:!0,isFetchingVerification:!0,validationData:null,validationDataRetrievalError:!1,verificationError:null,fetchedValidationDataAt:null},function(){t.fetchValidationData(t.props.ticket),t.verifyTicketAgainstServer(t.props.ticket),t.checkIfTicketIsScannedByStaff(t.props.ticket.ticketId)})}},{key:"fetchValidationData",value:function(t){var n,s,o,c,l,u,p;return regeneratorRuntime.async(function(v){for(;;)switch(v.prev=v.next){case 0:return n=this.props,s=n.isVisible,o=n.location,v.prev=1,v.next=4,regeneratorRuntime.awrap((0,f.getSingleValidationDataFromDatabase)(t.ticketId));case 4:c=v.sent,this.setValidationData(c),this.state.validationDataRetrievalError&&B.remoteLogger.info(B.sources.tickets,"Kunne ikke vise bilde p\xe5 billett "+t.ticketId,c&&JSON.stringify(c)),k.logInspectionModalEvent.withExistingData(t.ticketId,s,o),v.next=26;break;case 10:return v.prev=10,v.t0=v.catch(1),v.prev=12,v.next=15,regeneratorRuntime.awrap((0,h.fetchValidationDataForTickets)([t],'oppstart av inspeksjonsmodal'));case 15:l=v.sent,S=1,u=T(y=l)||I(y,S)||w(),p=u[0],this.setValidationData(p),k.logInspectionModalEvent.withFetchedData(t.ticketId,s,o),v.next=26;break;case 22:v.prev=22,v.t1=v.catch(12),this.setValidationDataRetrievalFailed(),k.logInspectionModalEvent.withoutObtainingData(t.ticketId,s,o);case 26:case"end":return v.stop()}var y,S},null,this,[[1,10],[12,22]])}},{key:"setValidationData",value:function(t){if(!_(t))return this.setValidationDataRetrievalFailed();this.setState({isFetching:!1,fetchedValidationDataAt:(0,s.default)(),validationDataRetrievalError:!1,validationData:t})}},{key:"setValidationDataRetrievalFailed",value:function(){this.setState({isFetching:!1,fetchedValidationDataAt:null,validationData:null,validationDataRetrievalError:!0})}},{key:"checkIfTicketIsScannedByStaff",value:function(t){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.t0=this,n.next=4,regeneratorRuntime.awrap((0,b.isTicketScanned)(t));case 4:n.t1=n.sent,n.t2={isTicketScannedByStaff:n.t1},n.t0.setState.call(n.t0,n.t2),n.next=12;break;case 9:n.prev=9,n.t3=n.catch(0),console.log('Couldnt fetch manually inspected tickets',n.t3);case 12:case"end":return n.stop()}},null,this,[[0,9]])}},{key:"handleTicketScannedByStaff",value:function(t){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,regeneratorRuntime.awrap((0,b.setTicketAsScanned)(t));case 2:y.default.TICKET_MANUALLY_INSPECTED({ticketId:t}),this.setState({isTicketScannedByStaff:!0});case 4:case"end":return n.stop()}},null,this)}},{key:"verifyTicketAgainstServer",value:function(t){var n;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,regeneratorRuntime.awrap((0,h.verifyTicket)(t.ticketId));case 3:this.setVerificationOk(),s.next=9;break;case 6:s.prev=6,s.t0=s.catch(0),this.setVerificationFailed(null!=(n=s.t0.message)?n:'Could not verify ticket!');case 9:case"end":return s.stop()}},null,this,[[0,6]])}},{key:"setVerificationOk",value:function(){this.setState({isFetchingVerification:!1})}},{key:"setVerificationFailed",value:function(t){this.setState({isFetchingVerification:!1,verificationError:t})}},{key:"render",value:function(){var s=this.props,l=s.ticket,f=s.isVisible,h=s.onClose,y=this.state,k=y.isFetching,S=y.validationData,b=y.validationDataRetrievalError,B=l&&(0,c.isBusTicket)(l)?v.default:p.default;return t.default.createElement(n.default,{isVisible:f,onRequestClose:h,onBackdropPress:h,swipeDirection:"down",onSwipeThreshold:1e3,onSwipeComplete:h,propagateSwipe:!0,hideModalContentWhileAnimating:!0,style:{marginTop:20,marginBottom:0,marginHorizontal:0,paddingTop:(0,o.isNotchPhone)()?42:24}},t.default.createElement(t.default.Fragment,null,t.default.createElement(u.default,{toBackground:this.resetScreenBrightness,toInactive:this.resetScreenBrightness,toActive:this.handleAppBecameActive}),t.default.createElement(B,{ticket:l,isTicketScannedByStaff:this.state.isTicketScannedByStaff,onTicketScannedByStaff:this.handleTicketScannedByStaff,validationData:S,retrievalError:b,isFetching:k,onClose:h})))}}])&&E(V.prototype,F),j&&E(V,j),D})(),_=function(t){return Boolean(t&&(t.validationImage||t.qrCode))},M=function(t,n){var o=(0,c.getOperatingTimeOffsetInMinutes)(n),u=(0,s.default)().subtract(o,'minutes'),f=t.clone().subtract(o,'minutes');return!(0,l.isSameDay)(u,f)},P=j;e.default=P},1567,[7,1242,628,968,669,670,1455,663,662,1568,1624,1294,661,632,1626,633]);