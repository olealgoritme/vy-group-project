__d(function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=(function(t){if(t&&t.__esModule)return t;if(null===t||"object"!=typeof t&&"function"!=typeof t)return{default:t};var n=v();if(n&&n.has(t))return n.get(t);var s={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in t)if(Object.prototype.hasOwnProperty.call(t,u)){var c=o?Object.getOwnPropertyDescriptor(t,u):null;c&&(c.get||c.set)?Object.defineProperty(s,u,c):s[u]=t[u]}s.default=t,n&&n.set(t,s);return s})(r(d[0])),n=r(d[1]),s=(r(d[2]),r(d[3])),o=r(d[4]),u=r(d[5]),c=r(d[6]),p=f(r(d[7])),l=r(d[8]),h=r(d[9]),y=r(d[10]),P=f(r(d[11]));function f(t){return t&&t.__esModule?t:{default:t}}function v(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return v=function(){return t},t}function S(){return(S=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(t[o]=s[o])}return t}).apply(this,arguments)}function b(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function k(t,n){for(var s=0;s<n.length;s++){var o=n[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function C(t){return(C=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function w(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&E(t,n)}function E(t,n){return(E=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}var V=n.NativeModules.VippsBridge,O=new n.NativeEventEmitter(V),T='VIPPS_CALLBACK',x=1500;function I(t){return t.displayName||t.name||'Component'}var M=function(f){var v=(function(v){function E(t){var u,c,p;return b(this,E),c=this,p=C(E).call(this,t),(u=!p||"object"!=typeof p&&"function"!=typeof p?_(c):p).vippsEventSubscription=null,u.onVippsCallback=function(t,c){var p,l;if(u.setState({vippsCallbackReceived:!0}),clearTimeout(u.checkVippsPaymentStatusTimeout),(0,s.trackPaymentFlowSilently)({source:'VIPPS_RETURNED_APP_SWITCH',orderId:null==(p=u.state.order)?void 0:p.id,url:c}),!(0,o.isVippsCallback)(c)){var h,y="The provided URL isn't a valid Vipps-callback";return console.warn(y,c),void(0,s.trackPaymentFlowSilently)({source:'VIPPS_CALLBACK_URL_PARSING_FAILED',orderId:null==(h=u.state.order)?void 0:h.id,error:y,url:c})}u.removeVippsEventSubscription(),u.setState({isPerformingVippsPayment:!1});var P=(0,o.parseVippsUrlCallback)(c,null==(l=u.state.order)?void 0:l.id);P.didError?setTimeout(function(){n.Alert.alert('Vipps',P.message)},600):(console.log('Order amount successfully reserved with Vipps',P),t('VIPPS'))},u.state={order:void 0,paymentMethods:[],selectedPaymentMethodIndex:0,isCreatingOrder:!0,isCheckingVippsPaymentStatus:!1,vippsCallbackReceived:!1,isInitiatingPayment:!1,isPerformingVippsPayment:!1,storeNewPaymentCard:!1,isAdministratingCards:!1,errorMessage:void 0},u.getOrder=u.getOrder.bind(_(u)),u.handlePayment=u.handlePayment.bind(_(u)),u.handleDeleteCard=u.handleDeleteCard.bind(_(u)),u.handlePaymentMethodClicked=u.handlePaymentMethodClicked.bind(_(u)),u.handleStoreNewPaymentCardPressed=u.handleStoreNewPaymentCardPressed.bind(_(u)),u.administratingCards=u.administratingCards.bind(_(u)),u.removeVippsEventSubscription=u.removeVippsEventSubscription.bind(_(u)),u.handleSetErrorMessage=u.handleSetErrorMessage.bind(_(u)),u.changeTimePeriodTicket=u.changeTimePeriodTicket.bind(_(u)),u.handleOnClose=u.handleOnClose.bind(_(u)),u.checkVippsPaymentStatus=u.checkVippsPaymentStatus.bind(_(u)),u.addVippsEventSubscription=u.addVippsEventSubscription.bind(_(u)),u}var I,M,R;return w(E,t.Component),I=E,(M=[{key:"componentWillUnmount",value:function(){this.removeVippsEventSubscription()}},{key:"addVippsEventSubscription",value:function(t){var n,o=this;this.checkVippsPaymentStatusTimeout=setTimeout(function(){return o.checkVippsPaymentStatus(t)},1e4),(0,s.trackPaymentFlowSilently)({source:'VIPPS_ADDED_EVENT_SUBSCRIPTION',orderId:null==(n=this.state.order)?void 0:n.id}),this.vippsEventSubscription=O.addListener(T,function(n){return o.onVippsCallback(t,n)})}},{key:"removeVippsEventSubscription",value:function(){var t;clearTimeout(this.checkVippsPaymentStatusTimeout),(0,s.trackPaymentFlowSilently)({source:'VIPPS_REMOVE_EVENT_SUBSCRIPTION',orderId:null==(t=this.state.order)?void 0:t.id}),this.vippsEventSubscription&&(this.vippsEventSubscription.remove(),this.vippsEventSubscription=null)}},{key:"getOrder",value:function(t){var o,c,p,l=this;return regeneratorRuntime.async(function(y){for(;;)switch(y.prev=y.next){case 0:return y.prev=0,o=new Date,y.next=4,regeneratorRuntime.awrap((0,s.getOrder)(t));case 4:c=y.sent,p=new Date-o,setTimeout(function(){l.setState({isCreatingOrder:!1,paymentMethods:(0,u.getPaymentMethodsFromOrder)(c),order:c})},p<=x?x-p:0),y.next=13;break;case 10:y.prev=10,y.t0=y.catch(0),n.Alert.alert((0,P.default)('order_or_payment_failed_alert_title'),(0,h.getMessageFromErrorIfPresent)(y.t0)||(0,P.default)('get_order_failed_generic_message'),[{text:'OK'}]);case 13:case"end":return y.stop()}},null,null,[[0,10]])}},{key:"checkVippsPaymentStatus",value:function(t){var n,o,u,c=this;return regeneratorRuntime.async(function(p){for(;;)switch(p.prev=p.next){case 0:if(!this.state.vippsCallbackReceived){p.next=2;break}return p.abrupt("return");case 2:return p.prev=2,this.setState({isCheckingVippsPaymentStatus:!0}),p.next=6,regeneratorRuntime.awrap((0,s.getOrder)(null==(n=this.state.order)?void 0:n.id));case 6:o=p.sent,u=o.paymentStatus,(0,s.trackPaymentFlowSilently)({source:'VIPPS_PAYMENT_STATUS_POLLING',orderId:o.id,status:u}),p.t0=u,p.next='NONE'===p.t0?12:'INITIATED'===p.t0?13:'GO_TO_CAPTURE'===p.t0?15:'CAPTURED'===p.t0?15:'REJECTED'===p.t0?18:'CREDITED'===p.t0?18:'CANCELLED'===p.t0?18:21;break;case 12:return p.abrupt("break",21);case 13:return this.checkVippsPaymentStatusTimeout=setTimeout(function(){return c.checkVippsPaymentStatus(t)},2500),p.abrupt("break",21);case 15:return this.setState({isPerformingVippsPayment:!1}),t('VIPPS'),p.abrupt("break",21);case 18:return this.removeVippsEventSubscription(),this.setState({isPerformingVippsPayment:!1,errorMessage:(0,P.default)('vipps_rejected_error_message')}),p.abrupt("break",21);case 21:p.next=27;break;case 23:p.prev=23,p.t1=p.catch(2),this.checkVippsPaymentStatusTimeout=setTimeout(function(){return c.checkVippsPaymentStatus(t)},2500),console.log('Failed to check Vipps payment status:',p.t1);case 27:return p.prev=27,setTimeout(function(){c.setState({isCheckingVippsPaymentStatus:!1})},750),p.finish(27);case 30:case"end":return p.stop()}},null,this,[[2,23,27,30]])}},{key:"changeTimePeriodTicket",value:function(t,o){var u;return regeneratorRuntime.async(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,this.setState({isCreatingOrder:!0}),c.next=4,regeneratorRuntime.awrap((0,s.changeTimePeriodTicket)(t,o));case 4:u=c.sent,this.setState({order:u}),c.next=11;break;case 8:c.prev=8,c.t0=c.catch(0),n.Alert.alert((0,P.default)('order_or_payment_failed_alert_title'),(0,h.getMessageFromErrorIfPresent)(c.t0)||(0,P.default)('get_order_failed_generic_message'),[{text:'OK'}]);case 11:return c.prev=11,this.setState({isCreatingOrder:!1}),c.finish(11);case 14:case"end":return c.stop()}},null,this,[[0,8,11,14]])}},{key:"handlePayment",value:function(t,n,s){var o,c,p,l,y,f,v,S;return regeneratorRuntime.async(function(b){for(;;)switch(b.prev=b.next){case 0:if(o=this.state,c=o.paymentMethods,p=o.selectedPaymentMethodIndex,l=c[p],this.setState({isInitiatingPayment:!0,errorMessage:void 0}),b.prev=3,!(0,u.isStoredCardPaymentMethod)(l)){b.next=15;break}return b.next=7,regeneratorRuntime.awrap(this.performUserAuthentication(t));case 7:if(y=b.sent,f=y.authenticated,v=y.hotToken,!f){b.next=13;break}return b.next=13,regeneratorRuntime.awrap(this.preparePaymentWithStoredPaymentCard(l,v,n));case 13:b.next=24;break;case 15:b.t0=l.paymentType,b.next='CARD'===b.t0?18:'VIPPS'===b.t0?21:24;break;case 18:return b.next=20,regeneratorRuntime.awrap(this.preparePaymentWithNewPaymentCard(s));case 20:return b.abrupt("break",24);case 21:return b.next=23,regeneratorRuntime.awrap(this.preparePaymentWithVipps(n));case 23:return b.abrupt("break",24);case 24:b.next=30;break;case 26:b.prev=26,b.t1=b.catch(3),S=(0,h.getMessageFromErrorIfPresent)(b.t1)||(0,P.default)('prepare_payment_failed_generic_message'),this.setState({errorMessage:S});case 30:this.setState({isInitiatingPayment:!1});case 31:case"end":return b.stop()}},null,this,[[3,26]])}},{key:"performUserAuthentication",value:function(t){var n;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,regeneratorRuntime.awrap((0,c.authenticateForHotToken)((0,P.default)('biometrics_authentication_reason')+(t?' '+(0,P.default)('of')+' '+(0,l.getAmountFromOereWithCurrency)(t):'')));case 2:return(n=s.sent).error&&console.warn(n.error),s.abrupt("return",n);case 5:case"end":return s.stop()}})}},{key:"preparePaymentWithStoredPaymentCard",value:function(t,n,o){var u,c,p;return regeneratorRuntime.async(function(l){for(;;)switch(l.prev=l.next){case 0:if(this.state.order){l.next=2;break}throw Error('Tried to prepare payment with a stored card without an order present');case 2:return u=this.state.order,c=u.id,p=u.user,l.next=5,regeneratorRuntime.awrap((0,s.initiatePaymentWithStoredPaymentCard)(c,t.id,p,n));case 5:o(t.cardAssociation);case 6:case"end":return l.stop()}},null,this)}},{key:"preparePaymentWithNewPaymentCard",value:function(t){var n,o,u,c,p,l,h;return regeneratorRuntime.async(function(y){for(;;)switch(y.prev=y.next){case 0:if(n=this.state,o=n.order,u=n.storeNewPaymentCard,o){y.next=3;break}throw Error('Tried to prepare card payment without an order present');case 3:return c=o.id,p=o.user,y.next=6,regeneratorRuntime.awrap((0,s.initiatePaymentWithNewPaymentCard)(c,p,u));case 6:l=y.sent,h=l.url,t(h);case 9:case"end":return y.stop()}},null,this)}},{key:"preparePaymentWithVipps",value:function(t){var n,u,c,p,l,h=this;return regeneratorRuntime.async(function(y){for(;;)switch(y.prev=y.next){case 0:if(n=this.state.order){y.next=3;break}throw Error('Tried to prepare payment with Vipps without an order present');case 3:return y.next=5,regeneratorRuntime.awrap((0,o.canOpenVipps)());case 5:if(y.sent){y.next=9;break}return(0,o.showInstallAppAlert)(),y.abrupt("return");case 9:return u=n.id,c=n.user,y.next=12,regeneratorRuntime.awrap((0,s.initiatePaymentWithVipps)(u,c));case 12:p=y.sent,l=p.url,this.setState({isPerformingVippsPayment:!0,vippsCallbackReceived:!1},function(){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return h.addVippsEventSubscription(t),n.next=3,regeneratorRuntime.awrap(V.initiatePayment(l));case 3:(0,s.trackPaymentFlowSilently)({source:'VIPPS_PERFORM_APP_SWITCH',orderId:u});case 4:case"end":return n.stop()}})});case 15:case"end":return y.stop()}},null,this)}},{key:"handlePaymentMethodClicked",value:function(t){this.setState({selectedPaymentMethodIndex:t,storeNewPaymentCard:!1,isPerformingVippsPayment:!1})}},{key:"handleDeleteCard",value:function(){var t,s;return regeneratorRuntime.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(!(s=null==(t=this.state.paymentMethods[this.state.selectedPaymentMethodIndex])?void 0:t.id)){o.next=12;break}return o.prev=2,o.next=5,regeneratorRuntime.awrap((0,y.deletePaymentCard)(s));case 5:this.setState(function(t){return{paymentMethods:t.paymentMethods.filter(function(t){return t.id!==s}),selectedPaymentMethodIndex:0,isAdministratingCards:!1}}),p.default.DELETE_CARD({source:'BOOKING'}),o.next=12;break;case 9:o.prev=9,o.t0=o.catch(2),n.Alert.alert((0,P.default)('delete_card_error_alert'),(0,h.getMessageFromErrorIfPresent)(o.t0)||'');case 12:case"end":return o.stop()}},null,this,[[2,9]])}},{key:"administratingCards",value:function(){this.setState({isAdministratingCards:!this.state.isAdministratingCards,isPerformingVippsPayment:!1,selectedPaymentMethodIndex:0}),this.state.isAdministratingCards||p.default.ADMINISTER_PAYMENT_CARDS()}},{key:"handleStoreNewPaymentCardPressed",value:function(){this.setState(function(t){return{storeNewPaymentCard:!t.storeNewPaymentCard}})}},{key:"handleSetErrorMessage",value:function(t){this.setState({errorMessage:t})}},{key:"handleOnClose",value:function(t){var o=this;this.state.isPerformingVippsPayment?n.Alert.alert((0,P.default)('cancel_vipps_warning_title'),(0,P.default)('cancel_vipps_warning_message'),[{text:(0,P.default)('cancel_vipps_no'),style:'default'},{text:(0,P.default)('cancel_vipps_yes'),onPress:function(){var n;clearTimeout(o.checkVippsPaymentStatusTimeout),t(),(0,s.trackPaymentFlowSilently)({source:'VIPPS_USER_CANCELLED_POLLING',orderId:null==(n=o.state.order)?void 0:n.id})},style:'cancel'}]):t()}},{key:"render",value:function(){return t.createElement(t.Fragment,null,t.createElement(f,S({order:this.state.order,paymentMethods:this.state.paymentMethods,selectedPaymentMethodIndex:this.state.selectedPaymentMethodIndex,isCreatingOrder:this.state.isCreatingOrder,isCheckingVippsPaymentStatus:this.state.isCheckingVippsPaymentStatus,isInitiatingPayment:this.state.isInitiatingPayment,isPerformingVippsPayment:this.state.isPerformingVippsPayment,storeNewPaymentCard:this.state.storeNewPaymentCard,isAdministratingCards:this.state.isAdministratingCards,errorMessage:this.state.errorMessage,onGetOrder:this.getOrder,onHandlePayment:this.handlePayment,onHandleDeleteCard:this.handleDeleteCard,onHandlePaymentMethodClicked:this.handlePaymentMethodClicked,onHandleStoreNewPaymentCardPressed:this.handleStoreNewPaymentCardPressed,onAdministratingCards:this.administratingCards,onHandleSetErrorMessage:this.handleSetErrorMessage,onChangeTimePeriodTicket:this.changeTimePeriodTicket,handleOnClose:this.handleOnClose},this.props)))}}])&&k(I.prototype,M),R&&k(I,R),E})();return v.displayName="WithPayment("+I(f)+")",v};e.default=M},1910,[7,10,630,642,1710,1722,632,1294,1236,636,616,1234]);