__d(function(g,r,i,a,m,e,d){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=(function(t){if(t&&t.__esModule)return t;if(null===t||"object"!=typeof t&&"function"!=typeof t)return{default:t};var n=x();if(n&&n.has(t))return n.get(t);var o={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var c in t)if(Object.prototype.hasOwnProperty.call(t,c)){var l=s?Object.getOwnPropertyDescriptor(t,c):null;l&&(l.get||l.set)?Object.defineProperty(o,c,l):o[c]=t[c]}o.default=t,n&&n.set(t,o);return o})(r(d[0])),n=r(d[1]),o=r(d[2]),s=r(d[3]),c=r(d[4]),l=r(d[5]),u=r(d[6]),f=r(d[7]),p=r(d[8]),v=R(r(d[9])),h=R(r(d[10])),y=R(r(d[11])),S=R(r(d[12])),b=R(r(d[13])),O=R(r(d[14])),w=r(d[15]),_=r(d[16]),M=R(r(d[17])),k=r(d[18]),A=r(d[19]);function R(t){return t&&t.__esModule?t:{default:t}}function x(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return x=function(){return t},t}function E(t){return I(t)||j(t)||P()}function P(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function j(t){if(("function"==typeof Symbol?Symbol.iterator:"@@iterator")in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function I(t){if(Array.isArray(t)){for(var n=0,o=new Array(t.length);n<t.length;n++)o[n]=t[n];return o}}function L(t,n){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);n&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),o.push.apply(o,s)}return o}function C(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?L(Object(o),!0).forEach(function(n){T(t,n,o[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):L(Object(o)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(o,n))})}return t}function T(t,n,o){return n in t?Object.defineProperty(t,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[n]=o,t}function N(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function B(t,n){for(var o=0;o<n.length;o++){var s=n[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function V(t){return(V=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function F(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function U(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&D(t,n)}function D(t,n){return(D=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}var W=function(){},J=(function(u){function w(t){var n,o,s;N(this,w),o=this,(n=!(s=V(w).call(this,t))||"object"!=typeof s&&"function"!=typeof s?F(o):s)._header=null;var c=t.navigation.state.params.order;return n.state={order:c,selectedAccommodationOnLeg:G(c.itineraries[0]),presentSeatMapForLegIndex:0,isReservingSeats:!1,isCancellingSeats:!1,isUpdatingAccommodation:!1,isSeatChooserModalVisible:!1},n.closeModal=n.closeModal.bind(F(n)),n.navigateBack=n.navigateBack.bind(F(n)),n.navigateToNextScreen=n.navigateToNextScreen.bind(F(n)),n.handleSeatsClickedInSeatMap=n.handleSeatsClickedInSeatMap.bind(F(n)),n.handleErrorInSeatMap=n.handleErrorInSeatMap.bind(F(n)),n.toggleSeatReservationModal=n.toggleSeatReservationModal.bind(F(n)),n.editReservedSeats=n.editReservedSeats.bind(F(n)),n.renderLeg=n.renderLeg.bind(F(n)),n}var R,x,P;return U(w,t.Component),R=w,(x=[{key:"componentDidMount",value:function(){var t=(0,n.findNodeHandle)(this._header);setTimeout(function(){(0,p.setAccessibilityFocus)(t)},500)}},{key:"closeModal",value:function(){this.cancelAllReservedSeatsSilently();var t=this.props.navigation,n=t.getParam('previousStack');n?t.navigate(n):t.goBack(null)}},{key:"navigateBack",value:function(){this.cancelAllReservedSeatsSilently(),this.props.navigation.goBack(null)}},{key:"navigateToSeatReservation",value:function(t){this.setState({presentSeatMapForLegIndex:t},this.toggleSeatReservationModal)}},{key:"navigateToNextScreen",value:function(){var t,n,o,s,c,l,u=this;return regeneratorRuntime.async(function(f){for(;;)switch(f.prev=f.next){case 0:return s=this.props.navigation.state.params.itinerary,f.next=3,regeneratorRuntime.awrap(_.UserAuthentication.isLoggedIn());case 3:c=f.sent,l=!1===c?'BookingLoginScreen':'OrderConfirmation',this.props.navigation.navigate(l,C({},this.props.navigation.state.params,{order:this.state.order,itinerary:null!=(t=null==(n=this.state.order)?void 0:null==(o=n.itineraries)?void 0:o[0])?t:s,refreshOrderData:function(t){return u.setState({order:t})}}));case 6:case"end":return f.stop()}},null,this)}},{key:"updateAccommodation",value:function(t,n,o){var c,l,u=this;return regeneratorRuntime.async(function(f){for(;;)switch(f.prev=f.next){case 0:return c=this.state.order,f.prev=1,this.setState({isUpdatingAccommodation:!0}),f.next=5,regeneratorRuntime.awrap((0,s.changeAccommodation)(c.id,{legId:t,accommodationType:n,numberOfAccommodations:o}));case 5:l=f.sent,this.setState({order:l,selectedAccommodationOnLeg:G(l.itineraries[0])}),f.next=12;break;case 9:f.prev=9,f.t0=f.catch(1),z((0,M.default)('change_accommodation_alert_title'),(0,A.getMessageFromErrorIfPresent)(f.t0)||(0,M.default)('change_accommodation_alert_message'),function(){u.updateAccommodation(t,n)},function(){u.setState({selectedAccommodationOnLeg:G(c.itineraries[0])})});case 12:return f.prev=12,this.setState({isUpdatingAccommodation:!1}),f.finish(12);case 15:case"end":return f.stop()}},null,this,[[1,9,12,15]])}},{key:"editReservedSeats",value:function(t){var n,o,s=this;return regeneratorRuntime.async(function(c){for(;;)switch(c.prev=c.next){case 0:n=this.state.order,o=n.itineraries[0].legs[t],this.setState({isCancellingSeats:!0},function(){setTimeout(function(){return regeneratorRuntime.async(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,c.next=3,regeneratorRuntime.awrap(s.cancelSeatsOnLeg(n.id,o));case 3:s.setState(function(t){var n,s,c=t.order;return{order:(n=c,s=o.id,C({},n,{itineraries:n.itineraries.map(function(t){return C({},t,{legs:t.legs.map(function(t){return t.id!==s?t:C({},t,{reservedSeats:[]})})})})}))}}),c.next=9;break;case 6:c.prev=6,c.t0=c.catch(0),z((0,M.default)('edit_reserved_seats_alert_title'),(0,A.getMessageFromErrorIfPresent)(c.t0)||(0,M.default)('edit_reserved_seats_alert_message'),function(){s.editReservedSeats(t)});case 9:return c.prev=9,s.setState({isCancellingSeats:!1}),c.finish(9);case 12:case"end":return c.stop()}},null,null,[[0,6,9,12]])},250)});case 3:case"end":return c.stop()}},null,this)}},{key:"cancelAllReservedSeatsSilently",value:function(){var t,n,o=this;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:t=this.state.order,n=t.itineraries[0].legs.filter(function(t){var n;return(null!=(n=t.reservedSeats)?n:[]).length>0}).map(function(n){return o.cancelSeatsOnLeg(t.id,n)}),Promise.all(n.map(function(t){return t.catch(W)}));case 3:case"end":return s.stop()}},null,this)}},{key:"cancelSeatsOnLeg",value:function(t,n){var o;return regeneratorRuntime.async(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,regeneratorRuntime.awrap((0,c.cancelSeatWithEsben)({orderId:t,trainJourneyIdentifier:n.trainJourney.identifier,seatIdentifiers:(null!=(o=n.reservedSeats)?o:[]).map(function(t){return t.identifier})}));case 2:return s.abrupt("return",s.sent);case 3:case"end":return s.stop()}})}},{key:"handleSeatsClickedInSeatMap",value:function(t){var n=this,o=this.state,s=o.order,l=o.presentSeatMapForLegIndex,u=o.selectedAccommodationOnLeg,f=s.itineraries[0].legs[l];this.setState({isReservingSeats:!0},function(){setTimeout(function(){var o;return regeneratorRuntime.async(function(p){for(;;)switch(p.prev=p.next){case 0:return p.prev=0,p.next=3,regeneratorRuntime.awrap((0,c.reserveSeatWithEsben)({orderId:s.id,trainJourney:f.trainJourney,type:u[l],seats:t.map(function(t){return{car:t.carNumber,seatNumber:t.seatNumber,carType:t.carType,compartmentNumber:t.compartmentNumber}})}));case 3:o=p.sent,n.setState(function(t){var n,s,c,l=t.order;return{order:(n=l,s=o,c=f.id,C({},n,{itineraries:n.itineraries.map(function(t){return C({},t,{legs:t.legs.map(function(t){return t.id!==c?t:C({},t,{reservedSeats:s})})})})}))}},n.toggleSeatReservationModal),p.next=10;break;case 7:p.prev=7,p.t0=p.catch(0),z((0,M.default)('reserve_seats_alert_title'),(0,A.getMessageFromErrorIfPresent)(p.t0)||(0,M.default)('reserve_seats_alert_message'),function(){n.handleSeatsClickedInSeatMap(t)});case 10:return p.prev=10,n.setState({isReservingSeats:!1}),p.finish(10);case 13:case"end":return p.stop()}},null,null,[[0,7,10,13]])},250)})}},{key:"handleErrorInSeatMap",value:function(t){console.warn(t)}},{key:"toggleSeatReservationModal",value:function(){this.setState(function(t){return{isSeatChooserModalVisible:!t.isSeatChooserModalVisible}})}},{key:"renderLeg",value:function(n){var o=this,s=n.leg,c=n.index;return t.createElement(b.default,{leg:s,isUpdatingAccommodation:this.state.isUpdatingAccommodation,isCancellingSeats:this.state.isCancellingSeats,selectedAccommodation:this.state.selectedAccommodationOnLeg[c],onShowAvailableSeats:function(){return o.navigateToSeatReservation(c)},onEditReservedSeats:function(){return o.editReservedSeats(c)},onAccommodationSelected:function(t,n){o.setState(function(n){var o=n.selectedAccommodationOnLeg;return{selectedAccommodationOnLeg:[].concat(E(o.slice(0,c)),[t.accommodationType],E(o.slice(c+1)))}},function(){return o.updateAccommodation(s.id,t.accommodationType,n)})}})}},{key:"render",value:function(){var s,c,u=this,p=this.props.navigation.state.params,b=p.itinerary,w=p.passengers,_=p.passengerCategories,A=null!=(s=this.state.order.itineraries[0])?s:b,R=A.selectedPriceOption,x=A.legs.filter(function(t){return'WALK'!==t.transportType}).some(function(t){return!t.selectedAccommodation}),E=this.state.isCancellingSeats||this.state.isReservingSeats||this.state.isUpdatingAccommodation;return t.createElement(f.ScreenView,{style:{backgroundColor:k.colors.brightGrey}},t.createElement(n.View,{ref:function(t){return u._header=t},style:{zIndex:10,backgroundColor:k.colors.white}},t.createElement(f.HeaderCard,null,t.createElement(h.default,{showVerticalLine:!0,headerText:(0,M.default)('where_would_you_sit'),onClose:E?function(){}:this.closeModal,onBackPress:this.navigateBack}))),t.createElement(n.ScrollView,{contentContainerStyle:{paddingTop:20,paddingBottom:100,justifyContent:'space-between'}},t.createElement(n.View,null,t.createElement(v.default,{itinerary:A,renderLeg:this.renderLeg}))),t.createElement(y.default,{isLoading:this.state.isUpdatingAccommodation,disabled:x,onPress:this.navigateToNextScreen,text:(0,M.default)('go_further')},t.createElement(K,{passengerSummary:(0,l.getPassengerSelectionSummary)(w,_),priceOption:R})),t.createElement(S.default,{isVisible:this.state.isSeatChooserModalVisible,onClose:this.toggleSeatReservationModal},t.createElement(o.SafeAreaView,{forceInset:{top:'never',bottom:'always'},style:{flex:1}},t.createElement(O.default,{onBackPress:this.toggleSeatReservationModal,onReserveSeat:this.handleSeatsClickedInSeatMap,onError:this.handleErrorInSeatMap,isReservingSeat:this.state.isReservingSeats,leg:A.legs[this.state.presentSeatMapForLegIndex],orderId:this.state.order.id,numberOfTravellers:null!=(c=w.length)?c:1,accommodation:this.state.selectedAccommodationOnLeg[this.state.presentSeatMapForLegIndex]}))))}}])&&B(R.prototype,x),P&&B(R,P),w})(),K=function(o){var s=o.passengerSummary,c=o.priceOption,l=(0,u.getAmountFromOereWithCurrency)(c.amountInOere),p=(0,M.default)('chosen_price_options')+': '+c.name+'. '+s+', '+l;return t.createElement(n.View,{accessible:!0,accessibilityRole:"summary",accessibilityLabel:p},t.createElement(n.View,{style:{flexDirection:'row',alignItems:'center'}},t.createElement(n.Image,{resizeMode:"contain",source:w.ticketBlack}),t.createElement(f.MediumTextBold,{style:{marginLeft:6}},c.name)),t.createElement(f.MediumText,null,s),t.createElement(f.MediumTextBold,{actionGreen:!0},l))};function z(t,o,s,c){n.Alert.alert(t,o,[{text:(0,M.default)('try_again'),onPress:s},{text:(0,M.default)('cancel'),onPress:c,style:'cancel'}])}function G(t){return t.legs.map(function(t){var n,o;return'WALK'===t.transportType?'UNKNOWN':null!=(n=null==(o=t.selectedAccommodation)?void 0:o.accommodationType)?n:'UNKNOWN'})}var H=J;e.default=H},1900,[7,10,435,642,1480,1296,1236,653,979,1887,1715,1741,1241,1901,1907,675,632,1234,414,636]);